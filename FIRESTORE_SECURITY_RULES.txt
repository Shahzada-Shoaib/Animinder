Firestore Security Rules - Copy these to Firebase Console

Go to: Firebase Console → Firestore Database → Rules → Edit Rules

Paste the following rules and click "Publish":

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
    }
    
    // Chats collection - CRITICAL for chat functionality
    match /chats/{chatId} {
      // Allow read if user is part of the chat
      allow read: if isAuthenticated() && 
        (request.auth.uid == resource.data.userId1 || 
         request.auth.uid == resource.data.userId2);
      
      // Allow create if user is one of the participants
      allow create: if isAuthenticated() && 
        (request.auth.uid == request.resource.data.userId1 || 
         request.auth.uid == request.resource.data.userId2);
      
      // Allow update if user is part of the chat
      allow update: if isAuthenticated() && 
        (request.auth.uid == resource.data.userId1 || 
         request.auth.uid == resource.data.userId2);
    }
    
    // Messages collection - CRITICAL for chat functionality
    // OLD STRUCTURE (kept for backward compatibility during migration)
    match /messages/{messageId} {
      // Allow read if user is sender or receiver
      allow read: if isAuthenticated() && 
        (request.auth.uid == resource.data.senderId || 
         request.auth.uid == resource.data.receiverId);
      
      // Allow create if user is the sender
      allow create: if isAuthenticated() && 
        request.auth.uid == request.resource.data.senderId;
      
      // Allow update (for marking as read) if user is the receiver
      allow update: if isAuthenticated() && 
        request.auth.uid == resource.data.receiverId;
    }
    
    // NEW STRUCTURE: Messages subcollection (RECOMMENDED)
    // Messages are now stored in chats/{chatId}/messages subcollection
    match /chats/{chatId}/messages/{messageId} {
      // Allow read if user is sender or receiver
      allow read: if isAuthenticated() && 
        (request.auth.uid == resource.data.senderId || 
         request.auth.uid == resource.data.receiverId);
      
      // Allow create if user is the sender
      allow create: if isAuthenticated() && 
        request.auth.uid == request.resource.data.senderId;
      
      // Allow update (for marking as read) if user is the receiver
      allow update: if isAuthenticated() && 
        request.auth.uid == resource.data.receiverId;
    }
    
    // Animals collection
    match /animals/{animalId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && 
        request.auth.uid == resource.data.ownerId;
    }
    
    // Matches collection
    match /matches/{matchId} {
      allow read: if isAuthenticated() && 
        (request.auth.uid == resource.data.userId1 || 
         request.auth.uid == resource.data.userId2);
      allow create: if isAuthenticated();
    }
    
    // Likes collection
    match /likes/{likeId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
        request.auth.uid == request.resource.data.likerUserId;
    }
  }
}

IMPORTANT NOTES:
1. Make sure you're logged in to Firebase in your app
2. These rules require authentication (request.auth != null)
3. After updating rules, wait 1-2 minutes for them to propagate
4. If you want to test quickly, you can temporarily use:
   allow read, write: if request.auth != null;
   (This allows all authenticated users to read/write - less secure but good for testing)

